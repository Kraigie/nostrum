<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.37.2">
    <meta name="project" content="nostrum v0.11.0-dev">


    <title>Multi-node — nostrum v0.11.0-dev</title>

    <link rel="stylesheet" href="dist/html-elixir-6X3L5KMG.css" />

    <script defer src="dist/sidebar_items-44F83C97.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-6XHBGSGW.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="https://github.com/Kraigie/nostrum" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="nostrum" />
        </a>

      <div>
        <a href="https://github.com/Kraigie/nostrum" class="sidebar-projectName" translate="no">
nostrum
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.11.0-dev
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of nostrum</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>Multi-node</h1>


      <a href="https://github.com/Kraigie/nostrum/blob/master/guides/advanced/multi_node.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>

<p>At the moment, you can run nostrum in highly available mode across multiple
nodes via OTP's distributed application support, and you can move bots between
nodes with no interruption in service.</p><p>As a general rule: if you are running distributed Erlang over the internet, make
sure to secure it with <a href="https://www.wireguard.com">a solid VPN</a> and / or by
<a href="https://www.erlang.org/doc/apps/ssl/ssl_distribution.html">using TLS for Erlang
distribution</a>.</p><h2 id="high-availability" class="section-heading">
  <a href="#high-availability" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">High availability</span>
</h2>
<p>Running using OTP's <a href="https://www.erlang.org/doc/design_principles/distributed_applications.html">distributed
applications</a>
allows us to connect multiple nodes together and have your app and nostrum
rescheduled on another node when things go south. Let's see how we can configure
it. In this example, we will make use of three nodes, and all of them will be
run from your bot's directory. The only difference on their command line is the
<code class="inline">--sname</code> / <code class="inline">--name</code> you specify. We'll use <code class="inline">--sname</code>s for testing here, for
proper fault tolerance you will want to use multiple hosts with <code class="inline">--name</code>. Let's
assume we name our nodes <code class="inline">joe</code>, <code class="inline">robert</code>, and <code class="inline">mike</code>.</p><h3 id="setting-up-distribution" class="section-heading">
  <a href="#setting-up-distribution" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Setting up distribution</span>
</h3>
<p>The avid reader will probably know that starting with the same <code class="inline">--cookie</code> and
<code class="inline">--sname</code> / <code class="inline">--name</code> is only step one, the nodes need to connect to each other
as well.</p><p>To be able to test this in interactive mode we will configure the settings in
Erlang configuration files, for releases you can use your regular
<code class="inline">config/prod.exs</code>. We will set up the following:</p><ul><li><p>Instruct OTP that our app, <code class="inline">:mybot</code> is a distributed app, and give it the
hosts to run it on.</p></li><li><p>On startup, tell OTP it should wait for the other nodes to become available.</p></li></ul><p>With the Erlang configuration files, this can be done as follows:</p><pre><code class="makeup erl" translate="no"><span class="c1">% mybot_joe.config</span><span class="w">
</span><span class="p" data-group-id="2517294782-1">[</span><span class="p" data-group-id="2517294782-2">{</span><span class="ss">kernel</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="2517294782-3">[</span><span class="p" data-group-id="2517294782-4">{</span><span class="ss">distributed</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2517294782-5">[</span><span class="p" data-group-id="2517294782-6">{</span><span class="ss">mybot</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2517294782-7">[</span><span class="ss">joe@HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2517294782-8">{</span><span class="ss">mike@HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="ss">robert@HOSTNAME</span><span class="p" data-group-id="2517294782-8">}</span><span class="p" data-group-id="2517294782-7">]</span><span class="p" data-group-id="2517294782-6">}</span><span class="p" data-group-id="2517294782-5">]</span><span class="p" data-group-id="2517294782-4">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="2517294782-9">{</span><span class="ss">sync_nodes_mandatory</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2517294782-10">[</span><span class="ss">mike@HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="ss">robert@HOSTNAME</span><span class="p" data-group-id="2517294782-10">]</span><span class="p" data-group-id="2517294782-9">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="2517294782-11">{</span><span class="ss">sync_nodes_timeout</span><span class="p">,</span><span class="w"> </span><span class="mi">30000</span><span class="p" data-group-id="2517294782-11">}</span><span class="p" data-group-id="2517294782-3">]</span><span class="p" data-group-id="2517294782-2">}</span><span class="p" data-group-id="2517294782-1">]</span><span class="p">.</span></code></pre><pre><code class="makeup erl" translate="no"><span class="c1">% mybot_robert.config</span><span class="w">
</span><span class="p" data-group-id="0009147667-1">[</span><span class="p" data-group-id="0009147667-2">{</span><span class="ss">kernel</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="0009147667-3">[</span><span class="p" data-group-id="0009147667-4">{</span><span class="ss">distributed</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0009147667-5">[</span><span class="p" data-group-id="0009147667-6">{</span><span class="ss">mybot</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0009147667-7">[</span><span class="ss">joe@HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0009147667-8">{</span><span class="ss">mike@HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="ss">robert@HOSTNAME</span><span class="p" data-group-id="0009147667-8">}</span><span class="p" data-group-id="0009147667-7">]</span><span class="p" data-group-id="0009147667-6">}</span><span class="p" data-group-id="0009147667-5">]</span><span class="p" data-group-id="0009147667-4">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="0009147667-9">{</span><span class="ss">sync_nodes_mandatory</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0009147667-10">[</span><span class="ss">joe@HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="ss">mike@HOSTNAME</span><span class="p" data-group-id="0009147667-10">]</span><span class="p" data-group-id="0009147667-9">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="0009147667-11">{</span><span class="ss">sync_nodes_timeout</span><span class="p">,</span><span class="w"> </span><span class="mi">30000</span><span class="p" data-group-id="0009147667-11">}</span><span class="p" data-group-id="0009147667-3">]</span><span class="p" data-group-id="0009147667-2">}</span><span class="p" data-group-id="0009147667-1">]</span><span class="p">.</span></code></pre><pre><code class="makeup erl" translate="no"><span class="c1">% mybot_mike.config</span><span class="w">
</span><span class="p" data-group-id="2881563077-1">[</span><span class="p" data-group-id="2881563077-2">{</span><span class="ss">kernel</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="2881563077-3">[</span><span class="p" data-group-id="2881563077-4">{</span><span class="ss">distributed</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2881563077-5">[</span><span class="p" data-group-id="2881563077-6">{</span><span class="ss">mybot</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2881563077-7">[</span><span class="ss">joe@HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2881563077-8">{</span><span class="ss">mike@HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="ss">robert@HOSTNAME</span><span class="p" data-group-id="2881563077-8">}</span><span class="p" data-group-id="2881563077-7">]</span><span class="p" data-group-id="2881563077-6">}</span><span class="p" data-group-id="2881563077-5">]</span><span class="p" data-group-id="2881563077-4">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="2881563077-9">{</span><span class="ss">sync_nodes_mandatory</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2881563077-10">[</span><span class="ss">joe@HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="ss">robert@HOSTNAME</span><span class="p" data-group-id="2881563077-10">]</span><span class="p" data-group-id="2881563077-9">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="2881563077-11">{</span><span class="ss">sync_nodes_timeout</span><span class="p">,</span><span class="w"> </span><span class="mi">30000</span><span class="p" data-group-id="2881563077-11">}</span><span class="p" data-group-id="2881563077-3">]</span><span class="p" data-group-id="2881563077-2">}</span><span class="p" data-group-id="2881563077-1">]</span><span class="p">.</span></code></pre><p>Note the only thing that changes is the <code class="inline">sync_node_mandatory</code> setting, which
instructs OTP which hosts to wait for on startup. The other settings must match.
These options instructs OTP that our app <code class="inline">:mybot</code> is distributed and should be
started at <code class="inline">:joe@HOSTNAME</code> first. If that fails, it moves to <code class="inline">:robert@HOSTNAME</code>
or <code class="inline">:mike@HOSTNAME</code>.</p><p>For details on the options, please see the <a href="https://www.erlang.org/doc/man/kernel_app.html">kernel reference
manual</a>.</p><h3 id="playtest" class="section-heading">
  <a href="#playtest" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Playtest</span>
</h3>
<p>In three distinct windows, run the following:</p><ol><li><code class="inline">iex --sname joe --cookie foo --erl-config myapp_joe.config -S mix</code></li><li><code class="inline">iex --sname robert --cookie foo --erl-config myapp_robert.config -S mix</code></li><li><code class="inline">iex --sname mike --cookie foo --erl-config myapp_mike.config -S mix</code></li></ol><p>If you have some other application that breaks on startup now - like monitoring
exporters that bind to specific ports, or similar things - this is when they
will blow up. Decide whether you want to run this on every node indeed or
include it with your app as shown above.</p><p>You now have three instances of the VM running. <code class="inline">:joe@HOSTNAME</code> runs your bot
right now. If you stop that node, one of the other two nodes will start running
your app. High availability complete.</p><h3 id="being-informed-about-takeover" class="section-heading">
  <a href="#being-informed-about-takeover" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Being informed about takeover</span>
</h3>
<p>Your application's <code class="inline">def start</code> function takes a <code class="inline">type</code> argument. In this case,
on the node that now runs your application, that <code class="inline">type</code> was <code class="inline">{:failover, :joe@HOSTNAME}</code>. If you start <code class="inline">:joe@HOSTNAME</code> back up, <code class="inline">:joe@HOSTNAME</code> is
started with <code class="inline">{:takeover, source_node}</code>, where <code class="inline">source_node</code> is the node that it
took over from.</p><h3 id="manual-takeover" class="section-heading">
  <a href="#manual-takeover" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Manual takeover</span>
</h3>
<p>If you want to move your app around manually, you can use
<code class="inline">:application.takeover</code>, for example <code class="inline">:application.takeover(:mybot, :permanent)</code>.</p><h3 id="final-thoughts" class="section-heading">
  <a href="#final-thoughts" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Final thoughts</span>
</h3>
<p>With this setup, nostrum can not perform any state synchronization between
nodes, it is an effective restart from scratch. For most bots, this type of
failover will be sufficient.</p><h2 id="migrating-bots-between-nodes" class="section-heading">
  <a href="#migrating-bots-between-nodes" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Migrating bots between nodes</span>
</h2>
<p>nostrum allows you to seamlessly migrate your bot from one to another node,
without losing any state or events. However, this requires some work.</p><h3 id="setup" class="section-heading">
  <a href="#setup" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Setup</span>
</h3>
<p>You will need the following prerequisites:</p><ul><li><p>You need to use mnesia-based caching <em>and</em> mnesia-based stores, see <a href="pluggable_caching.html">the
pluggable caching docs</a>. You may, of course, also use
another external caching &amp; store implementation which allows both nodes to work with
the same data.</p></li><li><p>At least the new bot needs to be started with manual sharding enabled by
setting <code class="inline">shards: :manual</code> in the associated <code class="inline">t:Nostrum.Bot.bot_options/0?</code>.</p></li></ul><p>Let's walk through this with a bot you're running locally to illustrate it.</p><h3 id="walkthrough" class="section-heading">
  <a href="#walkthrough" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Walkthrough</span>
</h3>
<p>We have configured our bot to use the mnesia-based caching, and set <code class="inline">shards: :manual</code> in our bot options.</p><p>We will start our bot in one terminal window:</p><pre><code class="makeup sh" translate="no"><span class="">iex --cookie mybot --sname joe -S mix
</span></code></pre><p>Let's start the shard session too:</p><pre><code class="makeup elixir" translate="no"><span class="n">iex</span><span class="p" data-group-id="1500241850-1">(</span><span class="n">joe</span><span class="na">@host</span><span class="p" data-group-id="1500241850-1">)</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">Nostrum.Shard.Supervisor</span><span class="o">.</span><span class="n">connect</span><span class="p" data-group-id="1500241850-2">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nc">MyBot</span><span class="o">.</span><span class="n">bot_options</span><span class="p" data-group-id="1500241850-3">(</span><span class="p" data-group-id="1500241850-3">)</span><span class="p" data-group-id="1500241850-2">)</span></code></pre><p>For the purpose of this example, <code class="inline">mike</code> is the node we want our bot to migrate
away from. In another terminal window, we will start it using:</p><pre><code class="makeup sh" translate="no"><span class="">iex --cookie mybot --sname mike -S mix run --no-start
</span></code></pre><p>We then connect <code class="inline">mike</code> to <code class="inline">joe</code> (note that <code class="inline">@host</code> depends on your hostname):</p><pre><code class="makeup elixir" translate="no"><span class="n">iex</span><span class="p" data-group-id="7801111747-1">(</span><span class="n">mike</span><span class="na">@host</span><span class="p" data-group-id="7801111747-1">)</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">Node</span><span class="o">.</span><span class="n">connect</span><span class="p" data-group-id="7801111747-2">(</span><span class="ss">:joe@host</span><span class="p" data-group-id="7801111747-2">)</span><span class="w">
</span><span class="no">true</span></code></pre><p>We will now connect <code class="inline">mike</code> to <code class="inline">joe</code>'s mnesia schema and persist it on mike:</p><pre><code class="makeup elixir" translate="no"><span class="n">iex</span><span class="p" data-group-id="8736154658-1">(</span><span class="n">mike</span><span class="na">@host</span><span class="p" data-group-id="8736154658-1">)</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">:mnesia</span><span class="o">.</span><span class="n">start</span><span class="p" data-group-id="8736154658-2">(</span><span class="ss">extra_db_nodes</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8736154658-3">[</span><span class="ss">:joe@host</span><span class="p" data-group-id="8736154658-3">]</span><span class="p" data-group-id="8736154658-2">)</span><span class="w">
</span><span class="ss">:ok</span><span class="w">
</span><span class="n">iex</span><span class="p" data-group-id="8736154658-4">(</span><span class="n">mike</span><span class="na">@host</span><span class="p" data-group-id="8736154658-4">)</span><span class="mi">3</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">:mnesia</span><span class="o">.</span><span class="n">change_table_copy_type</span><span class="p" data-group-id="8736154658-5">(</span><span class="ss">:schema</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p" data-group-id="8736154658-6">(</span><span class="p" data-group-id="8736154658-6">)</span><span class="p">,</span><span class="w"> </span><span class="ss">:disc_copies</span><span class="p" data-group-id="8736154658-5">)</span><span class="w">
</span><span class="p" data-group-id="8736154658-7">{</span><span class="ss">:atomic</span><span class="p">,</span><span class="w"> </span><span class="ss">:ok</span><span class="p" data-group-id="8736154658-7">}</span></code></pre><p>Running <a href="https://www.erlang.org/doc/apps/mnesia/mnesia.html#info/0"><code class="inline">:mnesia.info/0</code></a> reveals that mnesia considers both <code class="inline">joe@host</code> and
<code class="inline">mike@host</code> part of the cluster, whilst the <code class="inline">remote</code> tables are sitting on
<code class="inline">joe@host</code>. Let's start the bot locally now, by first stopping the current
session cleanly.</p><pre><code class="makeup elixir" translate="no"><span class="n">iex</span><span class="p" data-group-id="8564658499-1">(</span><span class="n">mike</span><span class="na">@host</span><span class="p" data-group-id="8564658499-1">)</span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">:init</span><span class="o">.</span><span class="n">stop</span><span class="p" data-group-id="8564658499-2">(</span><span class="p" data-group-id="8564658499-2">)</span><span class="w">
</span><span class="ss">:ok</span></code></pre><p>This should stop your node. Now start it again using:</p><pre><code class="makeup sh" translate="no"><span class="">iex --cookie mybot --sname mike -S mix
</span></code></pre><p>This time, the bot will start as well. Note that due to <code class="inline">:mnesia</code> starting and
finding <code class="inline">joe@host</code> as part of its cluster in the schema, the other node will
auto-connect:</p><pre><code class="makeup elixir" translate="no"><span class="n">iex</span><span class="p" data-group-id="2158905658-1">(</span><span class="n">mike</span><span class="na">@host</span><span class="p" data-group-id="2158905658-1">)</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">Node</span><span class="o">.</span><span class="n">list</span><span class="w">
</span><span class="p" data-group-id="2158905658-2">[</span><span class="ss">:joe@host</span><span class="p" data-group-id="2158905658-2">]</span></code></pre><p>Let's start by migrating our shard session over from <code class="inline">joe@host</code> to <code class="inline">mike@host</code>.
To do this, we will disconnect it from <code class="inline">joe@host</code>, transfer the resume
information to <code class="inline">mike@host</code>, and then start the shard on <code class="inline">mike@host</code>.</p><p>We will register our shell process on <code class="inline">mike@host</code> first:</p><pre><code class="makeup elixir" translate="no"><span class="n">iex</span><span class="p" data-group-id="2485185740-1">(</span><span class="n">mike</span><span class="na">@host</span><span class="p" data-group-id="2485185740-1">)</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">:global</span><span class="o">.</span><span class="n">register_name</span><span class="p" data-group-id="2485185740-2">(</span><span class="ss">:target</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p" data-group-id="2485185740-3">(</span><span class="p" data-group-id="2485185740-3">)</span><span class="p" data-group-id="2485185740-2">)</span><span class="w">
</span><span class="ss">:yes</span></code></pre><p>Then we will disconnect the shard on <code class="inline">joe@host</code> and send the resume information
to <code class="inline">:target</code> after informing nostrum which bot we want to disconnect.</p><pre><code class="makeup elixir" translate="no"><span class="n">iex</span><span class="p" data-group-id="0261823780-1">(</span><span class="n">joe</span><span class="na">@host</span><span class="p" data-group-id="0261823780-1">)</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">resume_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nostrum.Shard.Supervisor</span><span class="o">.</span><span class="n">disconnect</span><span class="p" data-group-id="0261823780-2">(</span><span class="mi">0</span><span class="p" data-group-id="0261823780-2">)</span><span class="w">
</span><span class="p" data-group-id="0261823780-3">%{</span><span class="w">
  </span><span class="ss">session</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;abcdefg&quot;</span><span class="p">,</span><span class="w">
  </span><span class="c1"># ... </span><span class="w">
</span><span class="p" data-group-id="0261823780-3">}</span><span class="w">
</span><span class="n">iex</span><span class="p" data-group-id="0261823780-4">(</span><span class="n">joe</span><span class="na">@host</span><span class="p" data-group-id="0261823780-4">)</span><span class="mi">3</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">:global</span><span class="o">.</span><span class="n">send</span><span class="p" data-group-id="0261823780-5">(</span><span class="ss">:target</span><span class="p">,</span><span class="w"> </span><span class="n">resume_info</span><span class="p" data-group-id="0261823780-5">)</span></code></pre><p>On <code class="inline">mike@host</code>, receive it and start the shard:</p><pre><code class="makeup elixir" translate="no"><span class="n">iex</span><span class="p" data-group-id="5270109771-1">(</span><span class="n">mike</span><span class="na">@host</span><span class="p" data-group-id="5270109771-1">)</span><span class="mi">3</span><span class="o">&gt;</span><span class="w"> </span><span class="n">resume_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">receive</span><span class="w"> </span><span class="k" data-group-id="5270109771-2">do</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="k" data-group-id="5270109771-2">end</span><span class="w">
</span><span class="p" data-group-id="5270109771-3">%{</span><span class="w">
  </span><span class="ss">session</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;abcdefg&quot;</span><span class="p">,</span><span class="w">
  </span><span class="c1"># ...</span><span class="w">
</span><span class="p" data-group-id="5270109771-3">}</span><span class="w">
</span><span class="n">iex</span><span class="p" data-group-id="5270109771-4">(</span><span class="n">mike</span><span class="na">@host</span><span class="p" data-group-id="5270109771-4">)</span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">Nostrum.Shard.Supervisor</span><span class="o">.</span><span class="n">reconnect</span><span class="p" data-group-id="5270109771-5">(</span><span class="n">resume_info</span><span class="p" data-group-id="5270109771-5">)</span><span class="w">
</span><span class="p" data-group-id="5270109771-6">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5270109771-7">#</span><span class="nc" data-group-id="5270109771-7">PID</span><span class="p" data-group-id="5270109771-7">&lt;</span><span class="mf">0.421</span><span class="o">.</span><span class="mi">0</span><span class="err">}</span></code></pre><!-- How the actual FUCK does this work? We are literally sending an anonymousfunction over the wire. WTF? --><section role="note" class="admonition tip"><h4 class="admonition-title tip">Handling bot setup in ready events</h4><p>It's common to handle bot setup such as registering commands in the <code class="inline">READY</code>
event. However, when resuming the shard session on a different node, you will
probably not receive this event. It is therefore recommended to move the
handler for this event out of the consumer and into a function you can call as
part of your takeover routine.</p></section><p>In your productive setup, you could have a dedicated globally registered process
handle &quot;takeover&quot; messages to start shards locally.</p><p>We have now transferred the shard session to the new node, ideally resuming with
0 loss. Note that a ratelimiter has been running on the new node ever since we
started our bot there, and nostrum has already started distributing requests
across both ratelimiters.</p><p>Let's now move our cache state to <code class="inline">mike@host</code> so we can stop <code class="inline">joe@host</code>. Note
that you might need to explicitly inform nostrum about your bot's name such that
it can figure out the table name, see <a href="Nostrum.Bot.html"><code class="inline">Nostrum.Bot</code></a> for details.</p><pre><code class="makeup elixir" translate="no"><span class="n">iex</span><span class="p" data-group-id="7294595209-1">(</span><span class="n">mike</span><span class="na">@host</span><span class="p" data-group-id="7294595209-1">)</span><span class="mi">5</span><span class="o">&gt;</span><span class="w"> </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Nostrum.Cache</span><span class="w">
</span><span class="n">iex</span><span class="p" data-group-id="7294595209-2">(</span><span class="n">mike</span><span class="na">@host</span><span class="p" data-group-id="7294595209-2">)</span><span class="mi">6</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">:mnesia</span><span class="o">.</span><span class="n">move_table_copy</span><span class="p" data-group-id="7294595209-3">(</span><span class="nc">Cache.ChannelGuildMapping.Mnesia</span><span class="o">.</span><span class="n">table</span><span class="p" data-group-id="7294595209-4">(</span><span class="p" data-group-id="7294595209-4">)</span><span class="p">,</span><span class="w"> </span><span class="ss">:joe@host</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p" data-group-id="7294595209-5">(</span><span class="p" data-group-id="7294595209-5">)</span><span class="p" data-group-id="7294595209-3">)</span><span class="w">
</span><span class="p" data-group-id="7294595209-6">{</span><span class="ss">:atomic</span><span class="p">,</span><span class="w"> </span><span class="ss">:ok</span><span class="p" data-group-id="7294595209-6">}</span><span class="w">
</span><span class="n">iex</span><span class="p" data-group-id="7294595209-7">(</span><span class="n">mike</span><span class="na">@host</span><span class="p" data-group-id="7294595209-7">)</span><span class="mi">7</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">:mnesia</span><span class="o">.</span><span class="n">move_table_copy</span><span class="p" data-group-id="7294595209-8">(</span><span class="nc">Cache.GuildCache.Mnesia</span><span class="o">.</span><span class="n">table</span><span class="p" data-group-id="7294595209-9">(</span><span class="p" data-group-id="7294595209-9">)</span><span class="p">,</span><span class="w"> </span><span class="ss">:joe@host</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p" data-group-id="7294595209-10">(</span><span class="p" data-group-id="7294595209-10">)</span><span class="p" data-group-id="7294595209-8">)</span><span class="w">
</span><span class="p" data-group-id="7294595209-11">{</span><span class="ss">:atomic</span><span class="p">,</span><span class="w"> </span><span class="ss">:ok</span><span class="p" data-group-id="7294595209-11">}</span><span class="w">
</span><span class="n">iex</span><span class="p" data-group-id="7294595209-12">(</span><span class="n">mike</span><span class="na">@host</span><span class="p" data-group-id="7294595209-12">)</span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">:mnesia</span><span class="o">.</span><span class="n">move_table_copy</span><span class="p" data-group-id="7294595209-13">(</span><span class="nc">Cache.MemberCache.Mnesia</span><span class="o">.</span><span class="n">table</span><span class="p" data-group-id="7294595209-14">(</span><span class="p" data-group-id="7294595209-14">)</span><span class="p">,</span><span class="w"> </span><span class="ss">:joe@host</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p" data-group-id="7294595209-15">(</span><span class="p" data-group-id="7294595209-15">)</span><span class="p" data-group-id="7294595209-13">)</span><span class="w">
</span><span class="p" data-group-id="7294595209-16">{</span><span class="ss">:atomic</span><span class="p">,</span><span class="w"> </span><span class="ss">:ok</span><span class="p" data-group-id="7294595209-16">}</span><span class="w">
</span><span class="n">iex</span><span class="p" data-group-id="7294595209-17">(</span><span class="n">mike</span><span class="na">@host</span><span class="p" data-group-id="7294595209-17">)</span><span class="mi">9</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">:mnesia</span><span class="o">.</span><span class="n">move_table_copy</span><span class="p" data-group-id="7294595209-18">(</span><span class="nc">Cache.PresenceCache.Mnesia</span><span class="o">.</span><span class="n">table</span><span class="p" data-group-id="7294595209-19">(</span><span class="p" data-group-id="7294595209-19">)</span><span class="p">,</span><span class="w"> </span><span class="ss">:joe@host</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p" data-group-id="7294595209-20">(</span><span class="p" data-group-id="7294595209-20">)</span><span class="p" data-group-id="7294595209-18">)</span><span class="w">
</span><span class="p" data-group-id="7294595209-21">{</span><span class="ss">:atomic</span><span class="p">,</span><span class="w"> </span><span class="ss">:ok</span><span class="p" data-group-id="7294595209-21">}</span><span class="w">
</span><span class="n">iex</span><span class="p" data-group-id="7294595209-22">(</span><span class="n">mike</span><span class="na">@host</span><span class="p" data-group-id="7294595209-22">)</span><span class="mi">10</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">:mnesia</span><span class="o">.</span><span class="n">move_table_copy</span><span class="p" data-group-id="7294595209-23">(</span><span class="nc">Cache.UserCache.Mnesia</span><span class="o">.</span><span class="n">table</span><span class="p" data-group-id="7294595209-24">(</span><span class="p" data-group-id="7294595209-24">)</span><span class="p">,</span><span class="w"> </span><span class="ss">:joe@host</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p" data-group-id="7294595209-25">(</span><span class="p" data-group-id="7294595209-25">)</span><span class="p" data-group-id="7294595209-23">)</span><span class="w">
</span><span class="p" data-group-id="7294595209-26">{</span><span class="ss">:atomic</span><span class="p">,</span><span class="w"> </span><span class="ss">:ok</span><span class="p" data-group-id="7294595209-26">}</span><span class="w">
</span><span class="n">iex</span><span class="p" data-group-id="7294595209-27">(</span><span class="n">mike</span><span class="na">@host</span><span class="p" data-group-id="7294595209-27">)</span><span class="mi">11</span><span class="o">&gt;</span><span class="w"> </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Nostrum.Store</span><span class="w">
</span><span class="n">iex</span><span class="p" data-group-id="7294595209-28">(</span><span class="n">mike</span><span class="na">@host</span><span class="p" data-group-id="7294595209-28">)</span><span class="mi">12</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">:mnesia</span><span class="o">.</span><span class="n">move_table_copy</span><span class="p" data-group-id="7294595209-29">(</span><span class="nc">Store.GuildShardMapping.Mnesia</span><span class="o">.</span><span class="n">table</span><span class="p" data-group-id="7294595209-30">(</span><span class="p" data-group-id="7294595209-30">)</span><span class="p">,</span><span class="w"> </span><span class="ss">:joe@host</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p" data-group-id="7294595209-31">(</span><span class="p" data-group-id="7294595209-31">)</span><span class="p" data-group-id="7294595209-29">)</span><span class="w">
</span><span class="p" data-group-id="7294595209-32">{</span><span class="ss">:atomic</span><span class="p">,</span><span class="w"> </span><span class="ss">:ok</span><span class="p" data-group-id="7294595209-32">}</span><span class="w">
</span><span class="n">iex</span><span class="p" data-group-id="7294595209-33">(</span><span class="n">mike</span><span class="na">@host</span><span class="p" data-group-id="7294595209-33">)</span><span class="mi">13</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">:mnesia</span><span class="o">.</span><span class="n">move_table_copy</span><span class="p" data-group-id="7294595209-34">(</span><span class="nc">Store.UnavailableGuild.Mnesia</span><span class="o">.</span><span class="n">table</span><span class="p" data-group-id="7294595209-35">(</span><span class="p" data-group-id="7294595209-35">)</span><span class="p">,</span><span class="w"> </span><span class="ss">:joe@host</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p" data-group-id="7294595209-36">(</span><span class="p" data-group-id="7294595209-36">)</span><span class="p" data-group-id="7294595209-34">)</span><span class="w">
</span><span class="p" data-group-id="7294595209-37">{</span><span class="ss">:atomic</span><span class="p">,</span><span class="w"> </span><span class="ss">:ok</span><span class="p" data-group-id="7294595209-37">}</span></code></pre><!-- TODO: Migrating multiple shards could probably be cleaner with some nostrum helpers. --><!-- TODO: Migrating caches could probably be cleaner with some nostrum helpers. --><!-- TODO: Migrating stores could probably be cleaner with some nostrum helpers. --><p>Now, check <a href="https://www.erlang.org/doc/apps/mnesia/mnesia.html#info/0"><code class="inline">:mnesia.info/0</code></a>. All tables should be transferred to <code class="inline">mike@host</code>.</p><p>Your bot has been transferred. Note that until <code class="inline">joe@host</code> stops, it will still
run a ratelimiter and handle some REST requests, as the <a href="Nostrum.Bot.html"><code class="inline">Nostrum.Bot</code></a> supervisor
in there will still be running.</p><p>You can now stop the <a href="Nostrum.Bot.html"><code class="inline">Nostrum.Bot</code></a> supervisor for said bot on <code class="inline">joe@host</code>, or the
entire node, if you wish.</p><!-- vim: set textwidth=80 sw=2 ts=2: -->
</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="manual_sharding.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Manual Sharding
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="pluggable_caching.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Pluggable caching
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/nostrum/0.11.0-dev" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/nostrum/0.11.0-dev">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/nostrum/0.11.0-dev/show/guides/advanced/multi_node.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="nostrum.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.37.2) for the

          <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
