<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.37.2">
    <meta name="project" content="nostrum v0.11.0-dev">


    <title>Multi-node — nostrum v0.11.0-dev</title>

    <link rel="stylesheet" href="dist/html-elixir-6X3L5KMG.css" />

    <script defer src="dist/sidebar_items-256C540E.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-6XHBGSGW.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="https://github.com/Kraigie/nostrum" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="nostrum" />
        </a>

      <div>
        <a href="https://github.com/Kraigie/nostrum" class="sidebar-projectName" translate="no">
nostrum
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.11.0-dev
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of nostrum</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>Multi-node</h1>


      <a href="https://github.com/Kraigie/nostrum/blob/master/guides/advanced/multi_node.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>

<p>At the moment, you can run nostrum in highly available mode across multiple
nodes via OTP's distributed application support, see below. Support for properly
distributing nostrum across multiple nodes and using them as one big entity is
not supported (yet).</p><p>As a general rule: if you are running distributed Erlang over the internet, make
sure to secure it with <a href="https://www.wireguard.com">a solid VPN</a> and / or by
<a href="https://www.erlang.org/doc/apps/ssl/ssl_distribution.html">using TLS for Erlang
distribution</a>.</p><h2 id="high-availability" class="section-heading">
  <a href="#high-availability" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">High availability</span>
</h2>
<p>Running using OTP's <a href="https://www.erlang.org/doc/design_principles/distributed_applications.html">distributed
applications</a>
allows us to connect multiple nodes together and have your app and nostrum
rescheduled on another node when things go south. Let's see how we can configure
it. In this example, we will make use of three nodes, and all of them will be
run from your bot's directory. The only difference on their command line is the
<code class="inline">--sname</code> / <code class="inline">--name</code> you specify. We'll use <code class="inline">--sname</code>s for testing here, for
proper fault tolerance you will want to use multiple hosts with <code class="inline">--name</code>. Let's
assume we name our nodes <code class="inline">joe</code>, <code class="inline">robert</code>, and <code class="inline">mike</code>.</p><h3 id="setting-up-distribution" class="section-heading">
  <a href="#setting-up-distribution" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Setting up distribution</span>
</h3>
<p>The avid reader will probably know that starting with the same <code class="inline">--cookie</code> and
<code class="inline">--sname</code> / <code class="inline">--name</code> is only step one, the nodes need to connect to each other
as well.</p><p>To be able to test this in interactive mode we will configure the settings in
Erlang configuration files, for releases you can use your regular
<code class="inline">config/prod.exs</code>. We will set up the following:</p><ul><li><p>Instruct OTP that our app, <code class="inline">:mybot</code> is a distributed app, and give it the
hosts to run it on.</p></li><li><p>On startup, tell OTP it should wait for the other nodes to become available.</p></li></ul><p>With the Erlang configuration files, this can be done as follows:</p><pre><code class="makeup erl" translate="no"><span class="c1">% mybot_joe.config</span><span class="w">
</span><span class="p" data-group-id="9004449857-1">[</span><span class="p" data-group-id="9004449857-2">{</span><span class="ss">kernel</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="9004449857-3">[</span><span class="p" data-group-id="9004449857-4">{</span><span class="ss">distributed</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9004449857-5">[</span><span class="p" data-group-id="9004449857-6">{</span><span class="ss">mybot</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9004449857-7">[</span><span class="ss">joe@HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9004449857-8">{</span><span class="ss">mike@HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="ss">robert@HOSTNAME</span><span class="p" data-group-id="9004449857-8">}</span><span class="p" data-group-id="9004449857-7">]</span><span class="p" data-group-id="9004449857-6">}</span><span class="p" data-group-id="9004449857-5">]</span><span class="p" data-group-id="9004449857-4">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="9004449857-9">{</span><span class="ss">sync_nodes_mandatory</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9004449857-10">[</span><span class="ss">mike@HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="ss">robert@HOSTNAME</span><span class="p" data-group-id="9004449857-10">]</span><span class="p" data-group-id="9004449857-9">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="9004449857-11">{</span><span class="ss">sync_nodes_timeout</span><span class="p">,</span><span class="w"> </span><span class="mi">30000</span><span class="p" data-group-id="9004449857-11">}</span><span class="p" data-group-id="9004449857-3">]</span><span class="p" data-group-id="9004449857-2">}</span><span class="p" data-group-id="9004449857-1">]</span><span class="p">.</span></code></pre><pre><code class="makeup erl" translate="no"><span class="c1">% mybot_robert.config</span><span class="w">
</span><span class="p" data-group-id="5336647902-1">[</span><span class="p" data-group-id="5336647902-2">{</span><span class="ss">kernel</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="5336647902-3">[</span><span class="p" data-group-id="5336647902-4">{</span><span class="ss">distributed</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5336647902-5">[</span><span class="p" data-group-id="5336647902-6">{</span><span class="ss">mybot</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5336647902-7">[</span><span class="ss">joe@HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5336647902-8">{</span><span class="ss">mike@HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="ss">robert@HOSTNAME</span><span class="p" data-group-id="5336647902-8">}</span><span class="p" data-group-id="5336647902-7">]</span><span class="p" data-group-id="5336647902-6">}</span><span class="p" data-group-id="5336647902-5">]</span><span class="p" data-group-id="5336647902-4">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="5336647902-9">{</span><span class="ss">sync_nodes_mandatory</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5336647902-10">[</span><span class="ss">joe@HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="ss">mike@HOSTNAME</span><span class="p" data-group-id="5336647902-10">]</span><span class="p" data-group-id="5336647902-9">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="5336647902-11">{</span><span class="ss">sync_nodes_timeout</span><span class="p">,</span><span class="w"> </span><span class="mi">30000</span><span class="p" data-group-id="5336647902-11">}</span><span class="p" data-group-id="5336647902-3">]</span><span class="p" data-group-id="5336647902-2">}</span><span class="p" data-group-id="5336647902-1">]</span><span class="p">.</span></code></pre><pre><code class="makeup erl" translate="no"><span class="c1">% mybot_mike.config</span><span class="w">
</span><span class="p" data-group-id="9879037043-1">[</span><span class="p" data-group-id="9879037043-2">{</span><span class="ss">kernel</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="9879037043-3">[</span><span class="p" data-group-id="9879037043-4">{</span><span class="ss">distributed</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9879037043-5">[</span><span class="p" data-group-id="9879037043-6">{</span><span class="ss">mybot</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9879037043-7">[</span><span class="ss">joe@HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9879037043-8">{</span><span class="ss">mike@HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="ss">robert@HOSTNAME</span><span class="p" data-group-id="9879037043-8">}</span><span class="p" data-group-id="9879037043-7">]</span><span class="p" data-group-id="9879037043-6">}</span><span class="p" data-group-id="9879037043-5">]</span><span class="p" data-group-id="9879037043-4">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="9879037043-9">{</span><span class="ss">sync_nodes_mandatory</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9879037043-10">[</span><span class="ss">joe@HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="ss">robert@HOSTNAME</span><span class="p" data-group-id="9879037043-10">]</span><span class="p" data-group-id="9879037043-9">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="9879037043-11">{</span><span class="ss">sync_nodes_timeout</span><span class="p">,</span><span class="w"> </span><span class="mi">30000</span><span class="p" data-group-id="9879037043-11">}</span><span class="p" data-group-id="9879037043-3">]</span><span class="p" data-group-id="9879037043-2">}</span><span class="p" data-group-id="9879037043-1">]</span><span class="p">.</span></code></pre><p>Note the only thing that changes is the <code class="inline">sync_node_mandatory</code> setting, which
instructs OTP which hosts to wait for on startup. The other settings must match.
These options instructs OTP that our app <code class="inline">:mybot</code> is distributed and should be
started at <code class="inline">:joe@HOSTNAME</code> first. If that fails, it moves to <code class="inline">:robert@HOSTNAME</code>
or <code class="inline">:mike@HOSTNAME</code>.</p><p>For details on the options, please see the <a href="https://www.erlang.org/doc/man/kernel_app.html">kernel reference
manual</a>.</p><h3 id="playtest" class="section-heading">
  <a href="#playtest" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Playtest</span>
</h3>
<p>In three distinct windows, run the following:</p><ol><li><code class="inline">iex --sname joe --cookie foo --erl-config myapp_joe.config -S mix</code></li><li><code class="inline">iex --sname robert --cookie foo --erl-config myapp_robert.config -S mix</code></li><li><code class="inline">iex --sname mike --cookie foo --erl-config myapp_mike.config -S mix</code></li></ol><p>If you have some other application that breaks on startup now - like monitoring
exporters that bind to specific ports, or similar things - this is when they
will blow up. Decide whether you want to run this on every node indeed or
include it with your app as shown above.</p><p>You now have three instances of the VM running. <code class="inline">:joe@HOSTNAME</code> runs your bot
right now. If you stop that node, one of the other two nodes will start running
your app. High availability complete.</p><h3 id="being-informed-about-takeover" class="section-heading">
  <a href="#being-informed-about-takeover" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Being informed about takeover</span>
</h3>
<p>Your application's <code class="inline">def start</code> function takes a <code class="inline">type</code> argument. In this case,
on the node that now runs your application, that <code class="inline">type</code> was <code class="inline">{:failover, :joe@HOSTNAME}</code>. If you start <code class="inline">:joe@HOSTNAME</code> back up, <code class="inline">:joe@HOSTNAME</code> is
started with <code class="inline">{:takeover, source_node}</code>, where <code class="inline">source_node</code> is the node that it
took over from.</p><h3 id="manual-takeover" class="section-heading">
  <a href="#manual-takeover" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Manual takeover</span>
</h3>
<p>If you want to move your app around manually, you can use
<code class="inline">:application.takeover</code>, for example <code class="inline">:application.takeover(:mybot, :permanent)</code>.</p><h3 id="final-thoughts" class="section-heading">
  <a href="#final-thoughts" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Final thoughts</span>
</h3>
<p>At present, nostrum can not perform any state synchronization between nodes, it
is an effective restart from scratch. For most bots, this type of failover will
be sufficient.</p><!-- vim: set textwidth=80 sw=2 ts=2: -->
</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="manual_sharding.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Manual Sharding
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="pluggable_caching.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Pluggable caching
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/nostrum/0.11.0-dev" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/nostrum/0.11.0-dev">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/nostrum/0.11.0-dev/show/guides/advanced/multi_node.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="nostrum.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.37.2) for the

          <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
