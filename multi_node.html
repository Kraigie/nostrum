<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.29.4">
    <meta name="project" content="Nostrum v0.9.0-alpha3">

    <title>Multi-node — Nostrum v0.9.0-alpha3</title>
    <link rel="stylesheet" href="dist/html-elixir-HHVY3JYD.css" />


    <script src="dist/handlebars.runtime-NWIB6V2M.js"></script>
    <script src="dist/handlebars.templates-XWGFFSCD.js"></script>
    <script src="dist/sidebar_items-033B6DAD.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/html-JDI3AVDD.js"></script>


  </head>
  <body data-type="extras" class="page-extra">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="main">

<button class="sidebar-button sidebar-toggle" aria-label="toggle sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<section class="sidebar">
  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button" aria-label="Submit Search">
      <i class="ri-search-2-line" aria-hidden="true" title="Submit search"></i>
    </button>
    <button type="button" tabindex="-1" class="search-close-button" aria-label="Cancel Search">
      <i class="ri-close-line ri-lg" aria-hidden="true" title="Cancel search"></i>
    </button>
    <label class="search-label">
      <p class="sr-only">Search</p>
      <input name="q" type="text" class="search-input" placeholder="Search..." aria-label="Input your search terms" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
    </label>
  </form>

  <div class="autocomplete">
    <div class="autocomplete-results">
    </div>
  </div>

  <div class="sidebar-header">

    <div class="sidebar-projectDetails">
      <a href="https://github.com/Kraigie/nostrum" class="sidebar-projectName" translate="no">
Nostrum
      </a>
      <div class="sidebar-projectVersion" translate="no">
        v0.9.0-alpha3
      </div>
    </div>
    <ul class="sidebar-listNav">
      <li><a id="extras-list-link" href="#full-list">Pages</a></li>

        <li><a id="modules-list-link" href="#full-list">Modules</a></li>


        <li><a id="tasks-list-link" href="#full-list"><span translate="no">Mix</span> Tasks</a></li>

    </ul>
  </div>

  <div class="gradient"></div>
  <ul id="full-list"></ul>
</section>

<section class="content">
  <output role="status" id="toast"></output>
  <div class="content-outer">
    <div id="content" class="content-inner">

<h1>
<button class="icon-action display-settings">
  <i class="ri-settings-3-line"></i>
  <span class="sr-only">Settings</span>
</button>


    <a href="https://github.com/Kraigie/nostrum/blob/master/guides/advanced/multi_node.md#L1" title="View Source" class="icon-action" rel="help">
      <i class="ri-code-s-slash-line" aria-hidden="true"></i>
      <span class="sr-only">View Source</span>
    </a>


  <span>Multi-node</span>
</h1>

<p>At the moment, you can run nostrum in highly available mode across multiple
nodes via OTP's distributed application support, see below. Support for properly
distributing nostrum across multiple nodes and using them as one big entity is
not supported (yet).</p><p>As a general rule: if you are running distributed Erlang over the internet, make
sure to secure it with <a href="https://www.wireguard.com">a solid VPN</a> and / or by
<a href="https://www.erlang.org/doc/apps/ssl/ssl_distribution.html">using TLS for Erlang
distribution</a>.</p><h2 id="high-availability" class="section-heading">
  <a href="#high-availability" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">high-availability</p>
  </a>
  High availability
</h2>
<p>Running using OTP's <a href="https://www.erlang.org/doc/design_principles/distributed_applications.html">distributed
applications</a>
allows us to connect multiple nodes together and have your app and nostrum
rescheduled on another node when things go south. Let's see how we can configure
it. In this example, we will make use of three nodes, and all of them will be
run from your bot's directory. The only difference on their command line is the
<code class="inline">--sname</code> / <code class="inline">--name</code> you specify. We'll use <code class="inline">--sname</code>s for testing here, for
proper fault tolerance you will want to use multiple hosts with <code class="inline">--name</code>. Let's
assume we name our nodes <code class="inline">joe</code>, <code class="inline">robert</code>, and <code class="inline">mike</code>.</p><h3 id="bundling-nostrum-with-our-app" class="section-heading">
  <a href="#bundling-nostrum-with-our-app" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">bundling-nostrum-with-our-app</p>
  </a>
  Bundling nostrum with our app
</h3>
<p>We want to colocate nostrum with our app to allow it to move around as our
application is moved around. For this, utilize OTP's <a href="https://www.erlang.org/doc/design_principles/included_applications.html">included
applications</a>
feature to include nostrum into our supervision tree. You also need to
explicitly include nostrum's dependencies to ensure they are started, as the
regular nostrum application startup won't handle it for you. This can be done by
changing your application definition in <code class="inline">mix.exs</code> as follows:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">application</span><span class="w"> </span><span class="k" data-group-id="4824299738-1">do</span><span class="w">
    </span><span class="p" data-group-id="4824299738-2">[</span><span class="w">
      </span><span class="ss">mod</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4824299738-3">{</span><span class="nc">MyBot.Application</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4824299738-4">[</span><span class="p" data-group-id="4824299738-4">]</span><span class="p" data-group-id="4824299738-3">}</span><span class="p">,</span><span class="w">
      </span><span class="ss">included_applications</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4824299738-5">[</span><span class="ss">:nostrum</span><span class="p" data-group-id="4824299738-5">]</span><span class="p">,</span><span class="w">
      </span><span class="c1"># You can see this with `mix app.tree nostrum`</span><span class="w">
      </span><span class="ss">extra_applications</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4824299738-6">[</span><span class="ss">:certifi</span><span class="p">,</span><span class="w"> </span><span class="ss">:gun</span><span class="p">,</span><span class="w"> </span><span class="ss">:inets</span><span class="p">,</span><span class="w"> </span><span class="ss">:jason</span><span class="p">,</span><span class="w"> </span><span class="ss">:kcl</span><span class="p">,</span><span class="w"> </span><span class="ss">:mime</span><span class="p" data-group-id="4824299738-6">]</span><span class="w">
      </span><span class="c1"># ...</span><span class="w">
    </span><span class="p" data-group-id="4824299738-2">]</span><span class="w">
  </span><span class="k" data-group-id="4824299738-1">end</span></code></pre><p>You also need to set <code class="inline">runtime: false</code> for <code class="inline">:nostrum</code> itself in your
dependencies, and any dependencies of your app that depend on <code class="inline">:nostrum</code>, such
as command frameworks like <code class="inline">:nosedrum</code>:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">deps</span><span class="w"> </span><span class="k" data-group-id="5848337875-1">do</span><span class="w">
    </span><span class="p" data-group-id="5848337875-2">[</span><span class="w">
      </span><span class="p" data-group-id="5848337875-3">{</span><span class="ss">:nostrum</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.8&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">runtime</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p" data-group-id="5848337875-3">}</span><span class="p">,</span><span class="w">
      </span><span class="c1"># {:nosedrum, &quot;~&gt; 0.6&quot;, runtime: false},</span><span class="w">
    </span><span class="p" data-group-id="5848337875-2">]</span><span class="w">
  </span><span class="k" data-group-id="5848337875-1">end</span></code></pre><p>You now need to add nostrum to your applications' children to start it as part
of your app:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">start</span><span class="p" data-group-id="4641107187-1">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p" data-group-id="4641107187-1">)</span><span class="w"> </span><span class="k" data-group-id="4641107187-2">do</span><span class="w">
    </span><span class="n">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="4641107187-3">[</span><span class="w">
      </span><span class="nc">Nostrum.Application</span><span class="p">,</span><span class="w">
      </span><span class="c1"># ...</span><span class="w">
    </span><span class="p" data-group-id="4641107187-3">]</span><span class="w">
  </span><span class="k" data-group-id="4641107187-2">end</span></code></pre><p>If you want to run some logic ahead of starting nostrum, you can naturally also
put it later into the list.</p><p>You can start your bot now, and it's going to run. If you look at your
bot's application in <code class="inline">:observer</code>, you will see that nostrum has now become one
with your bot. We call that integration engineering.</p><p>Now that our app bundles everything it needs with itself, this means starting
our app will also starting nostrum, and stopping will also stop nostrum. We need
this for step two.</p><h3 id="setting-up-distribution" class="section-heading">
  <a href="#setting-up-distribution" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">setting-up-distribution</p>
  </a>
  Setting up distribution
</h3>
<p>The avid reader will probably know that starting with the same <code class="inline">--cookie</code> and
<code class="inline">--sname</code> / <code class="inline">--name</code> is only step one, the nodes need to connect to each other
as well.</p><p>To be able to test this in interactive mode we will configure the settings in
Erlang configuration files, for releases you can use your regular
<code class="inline">config/prod.exs</code>. We will set up the following:</p><ul><li><p>Instruct OTP that our app, <code class="inline">:mybot</code> is a distributed app, and give it the
hosts to run it on.</p></li><li><p>On startup, tell OTP it should wait for the other nodes to become available.</p></li></ul><p>With the Erlang configuration files, this can be done as follows:</p><pre><code class="makeup erl" translate="no"><span class="c1">% mybot_joe.config</span><span class="w">
</span><span class="p" data-group-id="0026664035-1">[</span><span class="p" data-group-id="0026664035-2">{</span><span class="ss">kernel</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="0026664035-3">[</span><span class="p" data-group-id="0026664035-4">{</span><span class="ss">distributed</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0026664035-5">[</span><span class="p" data-group-id="0026664035-6">{</span><span class="ss">mybot</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0026664035-7">[</span><span class="ss">joe</span><span class="p">@</span><span class="n">HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0026664035-8">{</span><span class="ss">mike</span><span class="p">@</span><span class="n">HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="ss">robert</span><span class="p">@</span><span class="n">HOSTNAME</span><span class="p" data-group-id="0026664035-8">}</span><span class="p" data-group-id="0026664035-7">]</span><span class="p" data-group-id="0026664035-6">}</span><span class="p" data-group-id="0026664035-5">]</span><span class="p" data-group-id="0026664035-4">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="0026664035-9">{</span><span class="ss">sync_nodes_mandatory</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0026664035-10">[</span><span class="ss">mike</span><span class="p">@</span><span class="n">HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="ss">robert</span><span class="p">@</span><span class="n">HOSTNAME</span><span class="p" data-group-id="0026664035-10">]</span><span class="p" data-group-id="0026664035-9">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="0026664035-11">{</span><span class="ss">sync_nodes_timeout</span><span class="p">,</span><span class="w"> </span><span class="mi">30000</span><span class="p" data-group-id="0026664035-11">}</span><span class="p" data-group-id="0026664035-3">]</span><span class="p" data-group-id="0026664035-2">}</span><span class="p" data-group-id="0026664035-1">]</span><span class="p">.</span></code></pre><pre><code class="makeup erl" translate="no"><span class="c1">% mybot_robert.config</span><span class="w">
</span><span class="p" data-group-id="4943062601-1">[</span><span class="p" data-group-id="4943062601-2">{</span><span class="ss">kernel</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="4943062601-3">[</span><span class="p" data-group-id="4943062601-4">{</span><span class="ss">distributed</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4943062601-5">[</span><span class="p" data-group-id="4943062601-6">{</span><span class="ss">mybot</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4943062601-7">[</span><span class="ss">joe</span><span class="p">@</span><span class="n">HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4943062601-8">{</span><span class="ss">mike</span><span class="p">@</span><span class="n">HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="ss">robert</span><span class="p">@</span><span class="n">HOSTNAME</span><span class="p" data-group-id="4943062601-8">}</span><span class="p" data-group-id="4943062601-7">]</span><span class="p" data-group-id="4943062601-6">}</span><span class="p" data-group-id="4943062601-5">]</span><span class="p" data-group-id="4943062601-4">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="4943062601-9">{</span><span class="ss">sync_nodes_mandatory</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4943062601-10">[</span><span class="ss">joe</span><span class="p">@</span><span class="n">HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="ss">mike</span><span class="p">@</span><span class="n">HOSTNAME</span><span class="p" data-group-id="4943062601-10">]</span><span class="p" data-group-id="4943062601-9">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="4943062601-11">{</span><span class="ss">sync_nodes_timeout</span><span class="p">,</span><span class="w"> </span><span class="mi">30000</span><span class="p" data-group-id="4943062601-11">}</span><span class="p" data-group-id="4943062601-3">]</span><span class="p" data-group-id="4943062601-2">}</span><span class="p" data-group-id="4943062601-1">]</span><span class="p">.</span></code></pre><pre><code class="makeup erl" translate="no"><span class="c1">% mybot_mike.config</span><span class="w">
</span><span class="p" data-group-id="3329679242-1">[</span><span class="p" data-group-id="3329679242-2">{</span><span class="ss">kernel</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="3329679242-3">[</span><span class="p" data-group-id="3329679242-4">{</span><span class="ss">distributed</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3329679242-5">[</span><span class="p" data-group-id="3329679242-6">{</span><span class="ss">mybot</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3329679242-7">[</span><span class="ss">joe</span><span class="p">@</span><span class="n">HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3329679242-8">{</span><span class="ss">mike</span><span class="p">@</span><span class="n">HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="ss">robert</span><span class="p">@</span><span class="n">HOSTNAME</span><span class="p" data-group-id="3329679242-8">}</span><span class="p" data-group-id="3329679242-7">]</span><span class="p" data-group-id="3329679242-6">}</span><span class="p" data-group-id="3329679242-5">]</span><span class="p" data-group-id="3329679242-4">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="3329679242-9">{</span><span class="ss">sync_nodes_mandatory</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3329679242-10">[</span><span class="ss">joe</span><span class="p">@</span><span class="n">HOSTNAME</span><span class="p">,</span><span class="w"> </span><span class="ss">robert</span><span class="p">@</span><span class="n">HOSTNAME</span><span class="p" data-group-id="3329679242-10">]</span><span class="p" data-group-id="3329679242-9">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="3329679242-11">{</span><span class="ss">sync_nodes_timeout</span><span class="p">,</span><span class="w"> </span><span class="mi">30000</span><span class="p" data-group-id="3329679242-11">}</span><span class="p" data-group-id="3329679242-3">]</span><span class="p" data-group-id="3329679242-2">}</span><span class="p" data-group-id="3329679242-1">]</span><span class="p">.</span></code></pre><p>Note the only thing that changes is the <code class="inline">sync_node_mandatory</code> setting, which
instructs OTP which hosts to wait for on startup. The other settings must match.
These options instructs OTP that our app <code class="inline">:mybot</code> is distributed and should be
started at <code class="inline">:joe@HOSTNAME</code> first. If that fails, it moves to <code class="inline">:robert@HOSTNAME</code>
or <code class="inline">:mike@HOSTNAME</code>.</p><p>For details on the options, please see the <a href="https://www.erlang.org/doc/man/kernel_app.html">kernel reference
manual</a>.</p><h3 id="playtest" class="section-heading">
  <a href="#playtest" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">playtest</p>
  </a>
  Playtest
</h3>
<p>In three distinct windows, run the following:</p><ol><li><code class="inline">iex --sname joe --cookie foo --erl-config myapp_joe.config -S mix</code></li><li><code class="inline">iex --sname robert --cookie foo --erl-config myapp_robert.config -S mix</code></li><li><code class="inline">iex --sname mike --cookie foo --erl-config myapp_mike.config -S mix</code></li></ol><p>If you have some other application that breaks on startup now - like monitoring
exporters that bind to specific ports, or similar things - this is when they
will blow up. Decide whether you want to run this on every node indeed or
include it with your app as shown above.</p><p>You now have three instances of the VM running. <code class="inline">:joe@HOSTNAME</code> runs your bot
right now. If you stop that node, one of the other two nodes will start running
your app. High availability complete.</p><h3 id="being-informed-about-takeover" class="section-heading">
  <a href="#being-informed-about-takeover" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">being-informed-about-takeover</p>
  </a>
  Being informed about takeover
</h3>
<p>Your application's <code class="inline">def start</code> function takes a <code class="inline">type</code> argument. In this case,
on the node that now runs your application, that <code class="inline">type</code> was <code class="inline">{:failover, :joe@HOSTNAME}</code>. If you start <code class="inline">:joe@HOSTNAME</code> back up, <code class="inline">:joe@HOSTNAME</code> is
started with <code class="inline">{:takeover, source_node}</code>, where <code class="inline">source_node</code> is the node that it
took over from.</p><h3 id="manual-takeover" class="section-heading">
  <a href="#manual-takeover" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">manual-takeover</p>
  </a>
  Manual takeover
</h3>
<p>If you want to move your app around manually, you can use
<code class="inline">:application.takeover</code>, for example <code class="inline">:application.takeover(:mybot, :permanent)</code>.</p><h3 id="final-thoughts" class="section-heading">
  <a href="#final-thoughts" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">final-thoughts</p>
  </a>
  Final thoughts
</h3>
<p>At present, nostrum can not perform any state synchronization between nodes, it
is an effective restart from scratch. For most bots, this type of failover will
be sufficient.</p>
<div class="bottom-actions">
  <div class="bottom-actions-item">

      <a href="pluggable_caching.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Pluggable caching
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="hot_code_upgrade.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Hot code upgrade
        </span>
      </a>

  </div>
</div>
      <footer class="footer">
        <p>

            <span class="line">
              <a href="https://hex.pm/packages/nostrum/0.9.0-alpha3" class="footer-hex-package">Hex Package</a>

              <a href="https://preview.hex.pm/preview/nostrum/0.9.0-alpha3">Hex Preview</a>

                (<a href="https://preview.hex.pm/preview/nostrum/0.9.0-alpha3/show/guides/advanced/multi_node.md">current file</a>)

            </span>

          <span class="line">
            <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
              Search HexDocs
            </button>

              <a href="Nostrum.epub" title="ePub version">
                Download ePub version
              </a>

          </span>
        </p>

        <p class="built-using">
          Built using
          <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.29.4) for the

            <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

        </p>
      </footer>
    </div>
  </div>
</section>
</div>


  </body>
</html>
