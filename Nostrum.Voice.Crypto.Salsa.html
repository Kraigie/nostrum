<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.37.2">
    <meta name="project" content="nostrum v0.11.0-dev">


    <title>Nostrum.Voice.Crypto.Salsa â€” nostrum v0.11.0-dev</title>

    <link rel="stylesheet" href="dist/html-elixir-6X3L5KMG.css" />

    <script defer src="dist/sidebar_items-35D5AD02.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-6XHBGSGW.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="https://github.com/Kraigie/nostrum" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="nostrum" />
        </a>

      <div>
        <a href="https://github.com/Kraigie/nostrum" class="sidebar-projectName" translate="no">
nostrum
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.11.0-dev
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-module" id="main" data-type="modules">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of nostrum</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>
      <span translate="no">Nostrum.Voice.Crypto.Salsa</span> 
      <small class="app-vsn" translate="no">(nostrum v0.11.0-dev)</small>

    </h1>

      <a href="https://github.com/Kraigie/nostrum/blob/master/lib/nostrum/voice/crypto/salsa.ex#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


    <section id="moduledoc">
<p>Handles encryption and decryption of outgoing and incoming voice data when a Salsa encryption mode is selected</p><section role="note" class="admonition info"><h3 id="module-internal-module" class="admonition-title info section-heading">
  <a href="#module-internal-module" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Internal module</span>
</h3>
<p>This module is intended for exclusive usage inside of nostrum, and is
documented for completeness and curious cryptographic cats.</p></section><h3 id="module-purpose" class="section-heading">
  <a href="#module-purpose" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Purpose</span>
</h3>
<p>To support xsalsa20_poly1305 without a NIF, we have to implement the
Salsa20 cipher and HSalsa20 hash function to use 192-bit nonces in the capacity
of XSalsa20.</p><p>Along with leveraging the :crypto module to perform the poly1305 MAC function
and xor'ing arbitrary-length binaries, by being more thoughtful and explicit
with our implementation, we should be able to eek out better performance
than the <code class="inline">:kcl</code> package provides.</p><h3 id="module-implementation" class="section-heading">
  <a href="#module-implementation" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Implementation</span>
</h3>
<p>The <code class="inline">:kcl</code> package is an impressive pure-elixir NaCl/libsodium compatible library
that Nostrum previously used for voice encryption. For our usage with Discord voice,
we only need the ability to encrypt and decrypt with 32-byte keys using 24-byte
XSalsa20 nonces.</p><p>Some of the key differences in our implementation compared to Kcl</p><ul><li>Heavy use of explicit binary pattern matching instead of more traditional implicit enumeration</li><li>Intermediate block state stored in a 16-element tuple that is mutated during the 20-round hot loop instead of lists</li><li>Minimized the number binary copies, returning iolists when appropriate, instead of concatenating binaries</li><li>XOR whole keystream and message blocks instead of XOR'ing one byte at a time</li><li>Poly1305 MAC handled by crypto module instead of implemented in elixir</li><li>Only support 32-byte keys and 24-byte nonces (XSalsa20) instead of full NaCl/libsodium</li></ul><p>Additionally there appears to be a bug in how the 16-byte block count is serialized during key expansion:
It's supposed to be little endian, and it happens to be for blocks 0-255, but for larger block counts,
Kcl may become incompatible with NaCl/libsodium-type libraries. For Discord's use case of encrypting short
20 millisecond compressed audio packets, block counts were well-below this suspected problem threshold.</p><p>The cipher functions were implemented in the order they're defined in the original Salsa specification,
and though it's using a lot of explicit binary pattern matching, it turned out to be quite legible.
In a single statement of binary pattern matching, the 512-bit initial block state is cast into 16
little-endian 32-bit words. Standard elixir patterns might have you iterate through the binary until the
end was reached, but matching and casting all sixteen block elements in a single statement then returning
a tuple is explicit, clear, and simple to understand when referenced against the spec.</p><p>Readers interested in cryptography are encouraged to read more about the Salsa20/ChaCha20 ciphers.</p><p>References for Salsa family of ciphers</p><ul><li><a href="https://cr.yp.to/snuffle/spec.pdf">https://cr.yp.to/snuffle/spec.pdf</a></li><li><a href="https://cr.yp.to/chacha/chacha-20080128.pdf">https://cr.yp.to/chacha/chacha-20080128.pdf</a></li><li><a href="https://cr.yp.to/snuffle/xsalsa-20110204.pdf">https://cr.yp.to/snuffle/xsalsa-20110204.pdf</a></li><li><a href="https://datatracker.ietf.org/doc/html/rfc7539">https://datatracker.ietf.org/doc/html/rfc7539</a></li><li><a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-xchacha">https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-xchacha</a></li></ul><h3 id="module-performance-considerations" class="section-heading">
  <a href="#module-performance-considerations" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Performance considerations</span>
</h3>
<p>The entire keystream generation and xor'ing the message with the stream is done in elixir,
only performing the Poly1305 MAC function through the crypto module. Although it was implemented
as thoughtfully and explicitly as possible with memory usage and performance in mind, using any
of the Salsa modes will likely be less performant than ChaCha or AES.</p>
    </section>

</div>

  <section id="summary" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#summary">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Summary</span>
    </h1>
<div class="summary-functions summary">
  <h2>
    <a href="#functions">Functions</a>
  </h2>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#block_binary_to_tuple/1" data-no-tooltip="" translate="no">block_binary_to_tuple(arg)</a>

      </div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#decrypt/3" data-no-tooltip="" translate="no">decrypt(encrypted_message, key, nonce)</a>

      </div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#encrypt/3" data-no-tooltip="" translate="no">encrypt(plain_text, key, nonce)</a>

      </div>

    </div>

</div>

  </section>


  <section id="functions" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#functions">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Functions</span>
    </h1>
    <div class="functions-list">
<section class="detail" id="block_binary_to_tuple/1">

  <div class="detail-header">
    <a href="#block_binary_to_tuple/1" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">block_binary_to_tuple(arg)</h1>

        <span class="note">(since 0.10.0)</span>


        <a href="https://github.com/Kraigie/nostrum/blob/master/lib/nostrum/voice/crypto/salsa.ex#L143" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">


  </section>
</section>
<section class="detail" id="decrypt/3">

  <div class="detail-header">
    <a href="#decrypt/3" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">decrypt(encrypted_message, key, nonce)</h1>

        <span class="note">(since 0.10.0)</span>


        <a href="https://github.com/Kraigie/nostrum/blob/master/lib/nostrum/voice/crypto/salsa.ex#L241" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@spec</span> decrypt(<a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">binary</a>(), &lt;&lt;_::256&gt;&gt;, &lt;&lt;_::192&gt;&gt;) :: <a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">binary</a>() | :error</pre>

      </div>


  </section>
</section>
<section class="detail" id="encrypt/3">

  <div class="detail-header">
    <a href="#encrypt/3" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">encrypt(plain_text, key, nonce)</h1>

        <span class="note">(since 0.10.0)</span>


        <a href="https://github.com/Kraigie/nostrum/blob/master/lib/nostrum/voice/crypto/salsa.ex#L224" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@spec</span> encrypt(<a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">binary</a>(), &lt;&lt;_::256&gt;&gt;, &lt;&lt;_::192&gt;&gt;) :: <a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">iolist</a>()</pre>

      </div>


  </section>
</section>

    </div>
  </section>

    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/nostrum/0.11.0-dev" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/nostrum/0.11.0-dev">Hex Preview</a>

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="nostrum.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.37.2) for the

          <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
