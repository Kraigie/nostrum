<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.29.4">
    <meta name="project" content="Nostrum v0.7.0">

    <title>Events — Nostrum v0.7.0</title>
    <link rel="stylesheet" href="dist/html-elixir-HHVY3JYD.css" />


    <script src="dist/handlebars.runtime-NWIB6V2M.js"></script>
    <script src="dist/handlebars.templates-XWGFFSCD.js"></script>
    <script src="dist/sidebar_items-7A762AB3.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/html-JDI3AVDD.js"></script>


  </head>
  <body data-type="extras" class="page-extra">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="main">

<button class="sidebar-button sidebar-toggle" aria-label="toggle sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<section class="sidebar">
  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button" aria-label="Submit Search">
      <i class="ri-search-2-line" aria-hidden="true" title="Submit search"></i>
    </button>
    <button type="button" tabindex="-1" class="search-close-button" aria-label="Cancel Search">
      <i class="ri-close-line ri-lg" aria-hidden="true" title="Cancel search"></i>
    </button>
    <label class="search-label">
      <p class="sr-only">Search</p>
      <input name="q" type="text" class="search-input" placeholder="Search..." aria-label="Input your search terms" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
    </label>
  </form>

  <div class="autocomplete">
    <div class="autocomplete-results">
    </div>
  </div>

  <div class="sidebar-header">

    <div class="sidebar-projectDetails">
      <a href="https://github.com/Kraigie/nostrum" class="sidebar-projectName" translate="no">
Nostrum
      </a>
      <div class="sidebar-projectVersion" translate="no">
        v0.7.0
      </div>
    </div>
    <ul class="sidebar-listNav">
      <li><a id="extras-list-link" href="#full-list">Pages</a></li>

        <li><a id="modules-list-link" href="#full-list">Modules</a></li>


        <li><a id="tasks-list-link" href="#full-list"><span translate="no">Mix</span> Tasks</a></li>

    </ul>
  </div>

  <div class="gradient"></div>
  <ul id="full-list"></ul>
</section>

<section class="content">
  <output role="status" id="toast"></output>
  <div class="content-outer">
    <div id="content" class="content-inner">

<h1>
<button class="icon-action display-settings">
  <i class="ri-settings-3-line"></i>
  <span class="sr-only">Settings</span>
</button>


    <a href="https://github.com/Kraigie/nostrum/blob/master/guides/Events.md#L1" title="View Source" class="icon-action" rel="help">
      <i class="ri-code-s-slash-line" aria-hidden="true"></i>
      <span class="sr-only">View Source</span>
    </a>


  <span>Events</span>
</h1>

<p>Event handling is how your bot application will interact with the information
sent from Discord over a websocket connection. By defining an event handler for
an event, when something like a message is created or a channel is deleted, your
application can perform an action as a result of that event.</p><p>Nostrum uses <a href="https://www.erlang.org/doc/man/pg.html">Erlang's <code class="inline">:pg</code> module</a> to
determine which consumers are interested in events, via
<a href="Nostrum.ConsumerGroup.html"><code class="inline">Nostrum.ConsumerGroup</code></a>. This allows dynamic subscriptions at runtime, even
across nodes. Events are dispatched to group members as they appear fromthe
Discord Gateway after ingestion into the cache.</p><p>To see the documentation on using one of provided consumers, please see
<a href="Nostrum.Consumer.html"><code class="inline">Nostrum.Consumer</code></a>.</p><h2 id="implementation-details" class="section-heading">
  <a href="#implementation-details" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">implementation-details</p>
  </a>
  Implementation Details
</h2>
<p>The following information will define the general procedure of dispatching events.</p><h3 id="shard" class="section-heading">
  <a href="#shard" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">shard</p>
  </a>
  Shard
</h3>
<p>Every shard in the Nostrum application is ran as its own process. These shards
are all run under the same supervisor. As part of the setup for each shard, it
creates its own producer under a supervisor.</p><p>As events are sent to the shard, the following happens:</p><ol><li><p>Shard looks to see what type of event it is, only dispatch events are sent
to the producer.</p></li><li><p>If the event is a <code class="inline">Dispatch</code>, the payload is converted to an atom-keyed map.
This is done because over ETF (which Nostrum uses), map keys are sometimes
binaries and sometimes strings, making it a real headache. Additionally,
with atom keys, we can use the <code class="inline">Map.key</code> notation. This is normally
considered unsafe but a debug messages will be emitted if a key is unsafely
converted to an atom. In this way we can ensure that our atom table is not
growing unbounded.</p></li><li><p>The payload is then written to the cache. To make sure we're not overrunning
the cache, especially at startup with <code class="inline">request_guild_members</code> or other heavy
payloads, this is done in the shard itself. </p></li><li><p>The cache updates itself from the new data. In some cases, such as update or
delete events, it may send out a second &quot;old&quot; object as well, that helps the
library user to determine what changed.</p></li><li><p>After writing to the cache, the shard <code class="inline">send</code>s out the event after going
through the cache to all subscribed processes. In general, the payload will
often match the payload described by the official Discord API documentation.</p></li><li><p>The shard instructs the websocket client that it's ready to read more data.
This prevents flooding the shard with messages that it may not be able to
handle yet, thus growing the message queue and the memory usage.</p></li></ol><h3 id="consumer" class="section-heading">
  <a href="#consumer" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">consumer</p>
  </a>
  Consumer
</h3>
<p>The consumer is implemented by you. Nostrum's <code class="inline">use Nostrum.Consumer</code> will do
the bulk of the work of process setup. Note that every process that is
subscribed receives every event: it is therefore not recommended to create
multiple consumers if a single one could accomplish the job.</p><p>By default, the consumer will start a new process for every event. This allows
us to easily distribute the load across cores.</p><p>Nostrum wraps the <code class="inline">:pg</code> module to provide a straightforward interface for event
handling. One of the benefits to this approach is that we can abstract away the
manual linking of producer to consumer.</p>
<div class="bottom-actions">
  <div class="bottom-actions-item">

      <a href="state.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
State
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="voice.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Voice
        </span>
      </a>

  </div>
</div>
      <footer class="footer">
        <p>

            <span class="line">
              <a href="https://hex.pm/packages/nostrum/0.7.0" class="footer-hex-package">Hex Package</a>

              <a href="https://preview.hex.pm/preview/nostrum/0.7.0">Hex Preview</a>

                (<a href="https://preview.hex.pm/preview/nostrum/0.7.0/show/guides/Events.md">current file</a>)

            </span>

          <span class="line">
            <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
              Search HexDocs
            </button>

              <a href="Nostrum.epub" title="ePub version">
                Download ePub version
              </a>

          </span>
        </p>

        <p class="built-using">
          Built using
          <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.29.4) for the

            <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

        </p>
      </footer>
    </div>
  </div>
</section>
</div>


  </body>
</html>
