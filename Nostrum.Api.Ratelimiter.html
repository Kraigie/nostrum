<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.37.0">
    <meta name="project" content="nostrum v0.11.0-dev">


    <title>Nostrum.Api.Ratelimiter â€” nostrum v0.11.0-dev</title>

    <link rel="stylesheet" href="dist/html-elixir-6X3L5KMG.css" />

    <script defer src="dist/sidebar_items-D8DFC9B2.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-6VTPNSGQ.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="https://github.com/Kraigie/nostrum" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="nostrum" />
        </a>

      <div>
        <a href="https://github.com/Kraigie/nostrum" class="sidebar-projectName" translate="no">
nostrum
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.11.0-dev
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-module" id="main" data-type="modules">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of nostrum</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>
      <span translate="no">Nostrum.Api.Ratelimiter</span> 
      <small class="app-vsn" translate="no">(nostrum v0.11.0-dev)</small>

    </h1>

      <a href="https://github.com/Kraigie/nostrum/blob/master/lib/nostrum/api/ratelimiter.ex#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


    <section id="moduledoc">
<p>Handles REST calls to the Discord API while respecting ratelimits.</p><h2 id="module-purpose" class="section-heading">
  <a href="#module-purpose" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Purpose</span>
</h2>
<p>Discord's API returns information about ratelimits that we must respect. This
module performs serialization of these requests through a single process,
thus preventing concurrency issues from arising if two processes make a
remote API call at the same time.</p><section role="note" class="admonition info"><h3 id="module-internal-module" class="admonition-title info section-heading">
  <a href="#module-internal-module" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Internal module</span>
</h3>
<p>This module is intended for exclusive usage inside of nostrum, and is
documented for completeness and people curious to look behind the covers.</p></section><h2 id="module-asynchronous-requests" class="section-heading">
  <a href="#module-asynchronous-requests" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Asynchronous requests</span>
</h2>
<p>The ratelimiter is fully asynchronous internally. In theory, it also supports
queueing requests in an asynchronous manner. However, support for this is
currently not implemented in <a href="Nostrum.Api.html"><code class="inline">Nostrum.Api</code></a>.</p><p>If you want to make one or multiple asynchronous requests manually, you can
use the following pattern:</p><pre><code class="makeup elixir" translate="no"><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:gen_statem</span><span class="o">.</span><span class="n">send_request</span><span class="p" data-group-id="9492720427-1">(</span><span class="nc">Nostrum.Api.Ratelimiter</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9492720427-2">{</span><span class="ss">:queue</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p" data-group-id="9492720427-2">}</span><span class="p" data-group-id="9492720427-1">)</span><span class="w">
</span><span class="c1"># ...</span><span class="w">
</span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:gen_statem</span><span class="o">.</span><span class="n">receive_response</span><span class="p" data-group-id="9492720427-3">(</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">timeout</span><span class="p" data-group-id="9492720427-3">)</span></code></pre><p>where <code class="inline">request</code> is a map describing the request to run - see <a href="Nostrum.Api.html"><code class="inline">Nostrum.Api</code></a>
for more information. You can also send multiple requests at the same time
and wait for their response: see <a href="https://www.erlang.org/doc/apps/stdlib/gen_statem.html#reqids_add/3"><code class="inline">:gen_statem.reqids_add/3</code></a> and
<a href="https://www.erlang.org/doc/apps/stdlib/gen_statem.html#wait_response/3"><code class="inline">:gen_statem.wait_response/3</code></a> for more information.</p><h2 id="module-multi-node" class="section-heading">
  <a href="#module-multi-node" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Multi-node</span>
</h2>
<p>nostrum will transparently distribute client requests across all ratelimiter
running in the cluster. This allows us to account for per-route ratelimits
whilst still distributing work across cluster nodes. <strong>Note that the API
enforces a global user ratelimit across all requests</strong>, which we cannot
account for using this method.</p><h2 id="module-inner-workings" class="section-heading">
  <a href="#module-inner-workings" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Inner workings</span>
</h2>
<p>When a client process wants to perform some request on the Discord API, it
sends a request to the <code class="inline">:gen_statem</code> behind this module to ask it to <code class="inline">:queue</code>
the incoming request.</p><h3 id="module-connection-setup" class="section-heading">
  <a href="#module-connection-setup" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Connection setup</span>
</h3>
<p>The state machine begins its life in the <code class="inline">:disconnected</code> state. The state
represents wheher the state machine is connected to the HTTP endpoint,
connections are kept open for some time. If a request comes in, it will
transition to the <code class="inline">:connecting</code> state and try to open the connection. If this
succeeds, it transitions to the <code class="inline">:connected</code> state.</p><h3 id="module-queueing-requests" class="section-heading">
  <a href="#module-queueing-requests" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Queueing requests</span>
</h3>
<p>The state machine associates a <a href="https://www.erlang.org/doc/apps/stdlib/queue.html#t:queue/1"><code class="inline">:queue.queue/1</code></a> of <a href="#t:queued_request/0"><code class="inline">queued_request/0</code></a> to
each individual bucket, together with an internal count of remaining calls.
When queueing requests, the following cases occur:</p><ul><li><p>If there are no remaining calls in the bot's global ratelimit bucket or
there are no remaining calls in the bucket, the request is put into the
bucket's queue.</p></li><li><p>If there is an <code class="inline">:initial</code> running request to the bucket, the request is put
into the bucket's queue.</p></li><li><p>If there are more than 0 remaining calls on both the request-specific
bucket and the global bucket, the request is started right away. This allows
nostrum to dispatch multiple requests to the same endpoint as soon as
possible as long as calls remain.</p></li><li><p>If no ratelimit information is known for the bucket and remaining calls on
the global bucket, the request is sent out as the &quot;pioneer&quot; request that will
retrieve how many calls we have for this bucket (<code class="inline">:initial</code>, see above).</p></li><li><p>If none of the above is true, a new queue is created and the pending
rqeuest marked as the <code class="inline">:initial</code> request. It will be run as soon as the bot's
global limit limit expires.</p></li></ul><p>The request starting function, <code class="inline">:next</code>, will start new requests from the
queue as long as more calls are possible in the timeframe. Any requests are
then started asynchronously. Bookkeeping is set up to associate the resulting
<a href="https://hexdocs.pm/gun/2.1.0/gun.html#t:stream_ref/0"><code class="inline">:gun.stream_ref/0</code></a> with the original client along with its request and the
ratelimiter bucket.</p><p>Results from the HTTP connection are delivered non-blocking: simple responses
with purely status codes and no body (code <code class="inline">204</code>) will be sent in a single
message, other requests will be sent to us incrementally. To finally deliver
the full response body to the client with the final package, an internal
buffer of the body is kept. A possible future optimization could be having a
way for <code class="inline">:gun</code> to only send the ratelimiter state machine the initial
<code class="inline">:gun_response</code> and forward any item of the body directly to the client.</p><p>When the headers for a request have been received, the ratelimiter parses the
ratelimit information and starts off an internal timer expiring when the
ratelimits expire. It will also reschedule calls with the <code class="inline">:next</code> internal
event for as many remaining calls as it knows about. Once the timer expires
for the current bucket, two cases can happen:</p><ul><li><p>The queue has items: Schedule all items and repeat this later.</p></li><li><p>The queue is empty: Delete the queue and remaining calls from the
outstanding buckets.</p></li></ul><p>In practice, this means that we never store more information than we need,
and removes the previous regular bucket sweeping functionality that the
ratelimit buckets required.</p><p><strong>Global ratelimits</strong> (note this is a distinct ratelimit from the bot's
&quot;global&quot;, per-user ratelimit) are handled with the special <code class="inline">global_limit</code>
state. This state is entered for exactly the the <code class="inline">X-Ratelimit-Reset-After</code>
time provided in the global ratelimit response. This state does nothing apart
from postponing any events it receives and returning to the previous state
(<code class="inline">:connected</code>) once the global timeout is gone. Requests that failed because
of the global ratelimit are requeued after returning back into the regular
state: a warning is logged to inform you of this.</p><h3 id="module-failure-modes" class="section-heading">
  <a href="#module-failure-modes" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Failure modes</span>
</h3>
<h4>HTTP connection death</h4><p>If the HTTP connection dies, the ratelimiter will inform each affected client
by replying with <code class="inline">{:error, {:connection_died, reason}}</code>, where <code class="inline">reason</code> is
the reason as provided by the <code class="inline">:gun_down</code> event. It will then transition to
<code class="inline">:disconnected</code> state. If no requests were running at time the connection was
shut down - for instance, because we simply reached the maximum idle time on
the HTTP/2 connection - we will simply move on.</p><h4>Upstream errors</h4><p>The ratelimiter works by queueing requests aggressively as soon as it has
ratelimit information to do so. If no ratelimit information is available, for
instance, because Discord returned us a 502 status code, the ratelimiter will
not automatically kick the queue to start further running requests.</p><h4>Other internal issues</h4><p>Any other internal problems that are not handled appropriately in the
ratelimiter will crash it, effectively resulting in the complete loss of any
queued requests.</p><h3 id="module-implementation-benefits-drawbacks" class="section-heading">
  <a href="#module-implementation-benefits-drawbacks" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Implementation benefits &amp; drawbacks</span>
</h3>
<h4>A history of ratelimiting</h4><p>First, it is important to give a short history of nostrum's ratelimiting: pre
<code class="inline">0.8</code>, nostrum used to use a <a href="https://hexdocs.pm/elixir/GenServer.html"><code class="inline">GenServer</code></a> that would call out to ETS tables to
look up ratelimiting buckets for requests. If it needed to sleep before
issuing a request due to the bucket being exhausted, it would do so in the
server process and block other callers.</p><p>In nostrum 0.8, the existing ratelimiter bucket storage architecture was
refactored to be based around the <a href="pluggable_caching.html">pluggable caching
functionality</a>, and buckets with no
remaining calls were adjusted to be slept out on the client-side by having
the <a href="https://hexdocs.pm/elixir/GenServer.html"><code class="inline">GenServer</code></a> respond to the client with <code class="inline">{:error, {:retry_after, millis}}</code>
and the client trying again and again to schedule its requests. This allowed
users to distribute their ratelimit buckets around however they wish, out of
the box, nostrum shipped with an ETS and a Mnesia-based ratelimit bucket
store.</p><h4>Problems we solved</h4><p>The approach above still came with a few problems:</p><ul><li><p>Requests were still being done synchronously in the ratelimiter, and it was
blocked from anything else whilst running the requests, even though we are
theoretically free to start requests for other buckets while one is still
running.</p></li><li><p>The ratelimiter itself was half working on its own, but half required the
external storage mechanisms, which made the code hard to follow and required
regular automatic pruning because the store had no idea when a bucket was no
longer relevant on its own.</p></li><li><p>Requests would not be pipelined to run as soon as ideally possible.</p></li><li><p>The ratelimiter did not inform clients if their request died in-flight.</p></li><li><p>If the client disconnected before we returned the response, we had to
handle this explicitly via <code class="inline">handle_info</code>.</p></li></ul><p>The new state machine-based ratelimiter solves these problems.</p>
    </section>

</div>

  <section id="summary" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#summary">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Summary</span>
    </h1>
<div class="summary-types summary">
  <h2>
    <a href="#types">Types</a>
  </h2>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#t:bucket/0" data-no-tooltip="" translate="no">bucket()</a>

      </div>

        <div class="summary-synopsis"><p>A bucket for endpoints unter the same ratelimit.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#t:queued_request/0" data-no-tooltip="" translate="no">queued_request()</a>

      </div>

        <div class="summary-synopsis"><p>A bucket-specific request waiting to be queued, alongside its client.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#t:remaining/0" data-no-tooltip="" translate="no">remaining()</a>

      </div>

        <div class="summary-synopsis"><p>Remaining calls on a route, as provided by the API response.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#t:request/0" data-no-tooltip="" translate="no">request()</a>

      </div>

        <div class="summary-synopsis"><p>A request to make in the ratelimiter.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#t:state/0" data-no-tooltip="" translate="no">state()</a>

      </div>

        <div class="summary-synopsis"><p>The state of the ratelimiter.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#t:wrapped_token/0" data-no-tooltip="" translate="no">wrapped_token()</a>

      </div>

        <div class="summary-synopsis"><p>An anonymous function that returns the bot token.</p></div>

    </div>

</div>
<div class="summary-functions summary">
  <h2>
    <a href="#functions">Functions</a>
  </h2>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#callback_mode/0" data-no-tooltip="" translate="no">callback_mode()</a>

      </div>

        <div class="summary-synopsis"><p>Callback implementation for <a href="https://www.erlang.org/doc/apps/stdlib/gen_statem.html#c:callback_mode/0"><code class="inline">:gen_statem.callback_mode/0</code></a>.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#child_spec/1" data-no-tooltip="" translate="no">child_spec(opts)</a>

      </div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#code_change/4" data-no-tooltip="" translate="no">code_change(version, state, data, extra)</a>

      </div>

        <div class="summary-synopsis"><p>Callback implementation for <a href="https://www.erlang.org/doc/apps/stdlib/gen_statem.html#c:code_change/4"><code class="inline">:gen_statem.code_change/4</code></a>.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#connected/3" data-no-tooltip="" translate="no">connected(arg1, request, data)</a>

      </div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#connecting/3" data-no-tooltip="" translate="no">connecting(arg1, arg2, data)</a>

      </div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#disconnected/3" data-no-tooltip="" translate="no">disconnected(arg, arg2, data)</a>

      </div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#get_endpoint/2" data-no-tooltip="" translate="no">get_endpoint(route, method)</a>

      </div>

        <div class="summary-synopsis"><p>Retrieves a proper ratelimit endpoint from a given route and url.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#global_limit/3" data-no-tooltip="" translate="no">global_limit(arg1, next, data)</a>

      </div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#init/1" data-no-tooltip="" translate="no">init(wrapped_token)</a>

      </div>

        <div class="summary-synopsis"><p>Callback implementation for <a href="https://www.erlang.org/doc/apps/stdlib/gen_statem.html#c:init/1"><code class="inline">:gen_statem.init/1</code></a>.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#queue/1" data-no-tooltip="" translate="no">queue(request)</a>

      </div>

        <div class="summary-synopsis"><p>Queue the given request and wait for the response synchronously.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#start_link/1" data-no-tooltip="" translate="no">start_link(arg)</a>

      </div>

        <div class="summary-synopsis"><p>Starts the ratelimiter.</p></div>

    </div>

</div>

  </section>


  <section id="types" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#types">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Types</span>
    </h1>
    <div class="types-list">
<section class="detail" id="t:bucket/0">

  <div class="detail-header">
    <a href="#t:bucket/0" class="detail-link" data-no-tooltip="" aria-label="Link to this type">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">bucket()</h1>

        <span class="note">(since 0.9.0)</span>


        <a href="https://github.com/Kraigie/nostrum/blob/master/lib/nostrum/api/ratelimiter.ex#L223" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@type</span> bucket() :: <a href="https://hexdocs.pm/elixir/String.html#t:t/0">String.t</a>()</pre>

      </div>

<p>A bucket for endpoints unter the same ratelimit.</p>
  </section>
</section>
<section class="detail" id="t:queued_request/0">

  <div class="detail-header">
    <a href="#t:queued_request/0" class="detail-link" data-no-tooltip="" aria-label="Link to this type">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">queued_request()</h1>

        <span class="note">(since 0.9.0)</span>


        <a href="https://github.com/Kraigie/nostrum/blob/master/lib/nostrum/api/ratelimiter.ex#L241" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@type</span> queued_request() :: {<a href="#t:request/0">request</a>(), client :: <a href="https://www.erlang.org/doc/apps/stdlib/gen_statem.html#t:from/0">:gen_statem.from</a>()}</pre>

      </div>

<p>A bucket-specific request waiting to be queued, alongside its client.</p>
  </section>
</section>
<section class="detail" id="t:remaining/0">

  <div class="detail-header">
    <a href="#t:remaining/0" class="detail-link" data-no-tooltip="" aria-label="Link to this type">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">remaining()</h1>

        <span class="note">(since 0.9.0)</span>


        <a href="https://github.com/Kraigie/nostrum/blob/master/lib/nostrum/api/ratelimiter.ex#L256" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@type</span> remaining() :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">non_neg_integer</a>() | :initial</pre>

      </div>

<p>Remaining calls on a route, as provided by the API response.</p><p>The ratelimiter internally counts the remaining calls per route to dispatch
new requests as soon as it's capable of doing so, but this is only possible
if the API already provided us with ratelimit information for an endpoint.</p><p>Therefore, if the initial call on an endpoint is made, the special <code class="inline">:initial</code>
value is specified. This is used by the limit parsing function to set the
remaining calls if and only if it is the response for the initial call -
otherwise, the value won't represent the truth anymore.</p>
  </section>
</section>
<section class="detail" id="t:request/0">

  <div class="detail-header">
    <a href="#t:request/0" class="detail-link" data-no-tooltip="" aria-label="Link to this type">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">request()</h1>

        <span class="note">(since 0.9.0)</span>


        <a href="https://github.com/Kraigie/nostrum/blob/master/lib/nostrum/api/ratelimiter.ex#L229" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@type</span> request() :: %{
  method: :get | :post | :put | :delete,
  route: <a href="https://hexdocs.pm/elixir/String.html#t:t/0">String.t</a>(),
  body: <a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">iodata</a>(),
  headers: [{<a href="https://hexdocs.pm/elixir/String.html#t:t/0">String.t</a>(), <a href="https://hexdocs.pm/elixir/String.html#t:t/0">String.t</a>()}],
  params: <a href="https://hexdocs.pm/elixir/Enum.html#t:t/0">Enum.t</a>()
}</pre>

      </div>

<p>A request to make in the ratelimiter.</p>
  </section>
</section>
<section class="detail" id="t:state/0">

  <div class="detail-header">
    <a href="#t:state/0" class="detail-link" data-no-tooltip="" aria-label="Link to this type">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">state()</h1>

        <span class="note">(since 0.9.0)</span>


        <a href="https://github.com/Kraigie/nostrum/blob/master/lib/nostrum/api/ratelimiter.ex#L291" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@type</span> state() :: %{
  outstanding: %{
    required(<a href="#t:bucket/0">bucket</a>()) =&gt; {<a href="#t:remaining/0">remaining</a>(), <a href="https://www.erlang.org/doc/apps/stdlib/queue.html#t:queue/1">:queue.queue</a>(<a href="#t:queued_request/0">queued_request</a>())}
  },
  running: %{
    required(<a href="https://hexdocs.pm/gun/2.1.0/gun.html#t:stream_ref/0">:gun.stream_ref</a>()) =&gt; {<a href="#t:bucket/0">bucket</a>(), <a href="#t:request/0">request</a>(), <a href="https://www.erlang.org/doc/apps/stdlib/gen_statem.html#t:from/0">:gen_statem.from</a>()}
  },
  inflight: %{
    required(<a href="https://hexdocs.pm/gun/2.1.0/gun.html#t:stream_ref/0">:gun.stream_ref</a>()) =&gt;
      {status :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">non_neg_integer</a>(), headers :: [{<a href="https://hexdocs.pm/elixir/String.html#t:t/0">String.t</a>(), <a href="https://hexdocs.pm/elixir/String.html#t:t/0">String.t</a>()}],
       body :: <a href="https://hexdocs.pm/elixir/String.html#t:t/0">String.t</a>()}
  },
  conn: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">pid</a>() | nil,
  remaining_in_window: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">non_neg_integer</a>(),
  wrapped_token: <a href="#t:wrapped_token/0">wrapped_token</a>()
}</pre>

      </div>

<p>The state of the ratelimiter.</p><p>While this has no public use, it is still documented here to provide help
when tracing the ratelimiter via <a href="https://www.erlang.org/doc/apps/stdlib/sys.html#trace/2"><code class="inline">:sys.trace/2</code></a> or other means.</p><h2 id="t:state/0-fields" class="section-heading">
  <a href="#t:state/0-fields" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Fields</span>
</h2>
<ul><li><p><code class="inline">:outstanding</code>: Outstanding (unqueued) requests per bucket alongside with
the remaining calls that may be made on said bucket.</p></li><li><p><code class="inline">:running</code>: Requests that have been sent off. Used to associate back the
client with a request when the response comes in.</p></li><li><p><code class="inline">:inflight</code>: Requests for which we have started getting a response, but we
have not fully received it yet. For responses that have a body, this will
buffer their body until we can send it back to the client.</p></li><li><p><code class="inline">:conn</code>: The <code class="inline">:gun</code> connection backing the server. Used for making new
requests, and updated as the state changes.</p></li><li><p><code class="inline">:remaining_in_window</code>: How many calls we may still make to the API during
this time window. Reset automatically via timeouts.</p></li><li><p><code class="inline">:wrapped_token</code>: An anonymous function that is internally used to retrieve
the token. This is wrapped to ensure that it is not accidentally exposed in
stacktraces.</p></li></ul>
  </section>
</section>
<section class="detail" id="t:wrapped_token/0">

  <div class="detail-header">
    <a href="#t:wrapped_token/0" class="detail-link" data-no-tooltip="" aria-label="Link to this type">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">wrapped_token()</h1>

        <span class="note">(since 0.11.0)</span>


        <a href="https://github.com/Kraigie/nostrum/blob/master/lib/nostrum/api/ratelimiter.ex#L260" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@type</span> wrapped_token() :: (-&gt; <a href="https://hexdocs.pm/elixir/String.html#t:t/0">String.t</a>())</pre>

      </div>

<p>An anonymous function that returns the bot token.</p>
  </section>
</section>

    </div>
  </section>

  <section id="functions" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#functions">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Functions</span>
    </h1>
    <div class="functions-list">
<section class="detail" id="callback_mode/0">

  <div class="detail-header">
    <a href="#callback_mode/0" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">callback_mode()</h1>


        <a href="https://github.com/Kraigie/nostrum/blob/master/lib/nostrum/api/ratelimiter.ex#L325" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

<p>Callback implementation for <a href="https://www.erlang.org/doc/apps/stdlib/gen_statem.html#c:callback_mode/0"><code class="inline">:gen_statem.callback_mode/0</code></a>.</p>
  </section>
</section>
<section class="detail" id="child_spec/1">

  <div class="detail-header">
    <a href="#child_spec/1" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">child_spec(opts)</h1>


        <a href="https://github.com/Kraigie/nostrum/blob/master/lib/nostrum/api/ratelimiter.ex#L327" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">


  </section>
</section>
<section class="detail" id="code_change/4">

  <div class="detail-header">
    <a href="#code_change/4" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">code_change(version, state, data, extra)</h1>


        <a href="https://github.com/Kraigie/nostrum/blob/master/lib/nostrum/api/ratelimiter.ex#L936" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

<p>Callback implementation for <a href="https://www.erlang.org/doc/apps/stdlib/gen_statem.html#c:code_change/4"><code class="inline">:gen_statem.code_change/4</code></a>.</p>
  </section>
</section>
<section class="detail" id="connected/3">

  <div class="detail-header">
    <a href="#connected/3" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">connected(arg1, request, data)</h1>


        <a href="https://github.com/Kraigie/nostrum/blob/master/lib/nostrum/api/ratelimiter.ex#L396" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">


  </section>
</section>
<section class="detail" id="connecting/3">

  <div class="detail-header">
    <a href="#connecting/3" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">connecting(arg1, arg2, data)</h1>


        <a href="https://github.com/Kraigie/nostrum/blob/master/lib/nostrum/api/ratelimiter.ex#L370" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">


  </section>
</section>
<section class="detail" id="disconnected/3">

  <div class="detail-header">
    <a href="#disconnected/3" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">disconnected(arg, arg2, data)</h1>


        <a href="https://github.com/Kraigie/nostrum/blob/master/lib/nostrum/api/ratelimiter.ex#L341" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">


  </section>
</section>
<section class="detail" id="get_endpoint/2">

  <div class="detail-header">
    <a href="#get_endpoint/2" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">get_endpoint(route, method)</h1>


        <a href="https://github.com/Kraigie/nostrum/blob/master/lib/nostrum/api/ratelimiter.ex#L1037" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@spec</span> get_endpoint(<a href="https://hexdocs.pm/elixir/String.html#t:t/0">String.t</a>(), <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">atom</a>()) :: <a href="https://hexdocs.pm/elixir/String.html#t:t/0">String.t</a>()</pre>

      </div>

<p>Retrieves a proper ratelimit endpoint from a given route and url.</p>
  </section>
</section>
<section class="detail" id="global_limit/3">

  <div class="detail-header">
    <a href="#global_limit/3" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">global_limit(arg1, next, data)</h1>


        <a href="https://github.com/Kraigie/nostrum/blob/master/lib/nostrum/api/ratelimiter.ex#L900" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">


  </section>
</section>
<section class="detail" id="init/1">

  <div class="detail-header">
    <a href="#init/1" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">init(wrapped_token)</h1>


        <a href="https://github.com/Kraigie/nostrum/blob/master/lib/nostrum/api/ratelimiter.ex#L316" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

<p>Callback implementation for <a href="https://www.erlang.org/doc/apps/stdlib/gen_statem.html#c:init/1"><code class="inline">:gen_statem.init/1</code></a>.</p>
  </section>
</section>
<section class="detail" id="queue/1">

  <div class="detail-header">
    <a href="#queue/1" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">queue(request)</h1>


        <a href="https://github.com/Kraigie/nostrum/blob/master/lib/nostrum/api/ratelimiter.ex#L986" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

<p>Queue the given request and wait for the response synchronously.</p><p>Ratelimits on the endpoint are handled by the ratelimiter. Global ratelimits
will cause this to return an error.</p>
  </section>
</section>
<section class="detail" id="start_link/1">

  <div class="detail-header">
    <a href="#start_link/1" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">start_link(arg)</h1>


        <a href="https://github.com/Kraigie/nostrum/blob/master/lib/nostrum/api/ratelimiter.ex#L312" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@spec</span> start_link({<a href="https://hexdocs.pm/elixir/String.html#t:t/0">String.t</a>(), [<a href="https://www.erlang.org/doc/apps/stdlib/gen_statem.html#t:start_opt/0">:gen_statem.start_opt</a>()]}) :: <a href="https://www.erlang.org/doc/apps/stdlib/gen_statem.html#t:start_ret/0">:gen_statem.start_ret</a>()</pre>

      </div>

<p>Starts the ratelimiter.</p>
  </section>
</section>

    </div>
  </section>

    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/nostrum/0.11.0-dev" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/nostrum/0.11.0-dev">Hex Preview</a>

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="nostrum.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.37.0) for the

          <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
